# Modül 2: Veri Yönetimi: Indexing ve Mapping

---

## Doküman Yönetimi (CRUD Operasyonları)

* **Index API (Doküman Ekleme/Güncelleme):**
  * `PUT /{index}/_doc/{id}` : Belirli bir ID ile doküman ekleme/üzerine yazma.
  * `POST /{index}/_doc` : Elasticsearch'ün otomatik ID oluşturmasıyla doküman ekleme.
  * `_create` endpoint'i: `POST /{index}/_create/{id}` (Sadece ID yoksa oluşturur).

--

* `PUT /{index}/_doc/{id}` : Belirli bir ID ile doküman ekleme/üzerine yazma.

```http
PUT /products/_doc/1
{
  "product_name": "Super Fast Laptop Pro",
  "category": "Computers",
  "price": 1299.99,
  "in_stock": true,
  "features": ["16GB RAM", "512GB SSD", "Next-Gen CPU"]
}
```

--

* `POST /{index}/_doc` : Elasticsearch'ün otomatik ID oluşturmasıyla doküman ekleme.

```http
POST /application_logs/_doc
{
  "@timestamp": "2024-05-24T14:33:15.234Z",
  "level": "ERROR",
  "service_name": "payment-service",
  "host_ip": "10.0.1.25",
  "message": "Failed to process payment for order 12345: Connection timed out"
}
```

---

## Doküman Güncelleme (Update)

* **Tamamen Üzerine Yazma (`PUT`):**
* **Kısmi Güncelleme (`POST` ile `_update`):** Sadece belirli alanları güncellemek istiyorsan `_update` endpoint'i daha mantıklıdır.

  ```http
  POST /products/_update/1
  {
    "doc": {
      "price": 1249.99,
      "in_stock": true
    }
  }
  ```

---

## Doküman Silme (Delete)

```http
DELETE /products/_doc/1
```

Not: Hemen silinmez, silindi olarak işaretlenir ve daha sonra gerçekten temizlenir.

---

## Doküman Okuma (Get)

ID ile çekmek için :

```http
GET /products/_doc/1
```

---

## Meta Alanlar Ne İşe Yarar?

* `_index`: Dokümanın bulunduğu index'in adı.
* `_id`: Dokümanın benzersiz ID'si.
* `_version`: Dokümanın versiyon numarası.
* `_source`: Dokümanın asıl içeriği, yani senin eklediğin JSON verisi.
* `_score`: Bir arama sorgusu sonucunda dokümanın sorguyla ne kadar alakalı olduğunu gösteren skor. (Sadece arama sonuçlarında gelir).

---

## Toplu Taşıma: `_bulk` API'si ile Verimlilik Sanatı

`_bulk` API'si sayesinde birden fazla operasyonu (index, create, update, delete) tek bir HTTP isteği içinde gönderebilirsin. Bu, performansı ciddi şekilde artırır.

Bir taşla birden fazla kuş gıdıklama :D

--

`_bulk` endpoint'ine gönderilen veri formatında her operasyon için iki satır gerekir:

1. **Action ve Metadata Satırı:**
   1. `index`, `create`, `update`, `delete`
   2. Index/ID
2. **Kaynak Satırı (Opsiyonel):**
   1. `index`, `create` ve `update` için dokümanın içeriğini içerir.
   2. `delete` için bu satır gerekmez.

```http
POST /_bulk
{ "index" : { "_index" : "products", "_id" : "SKU004" } }
{ "product_name" : "Ergonomic Office Chair", "category" : "Furniture", "price": 299.00, "in_stock": true }
{ "index" : { "_index" : "application_logs-2024-05-24" } }
{ "@timestamp": "2024-05-24T15:01:00.000Z", "level": "INFO", "service_name": "user-service", "message": "User logged in: user@example.com" }
{ "index" : { "_index" : "application_logs-2024-05-24" } }
{ "@timestamp": "2024-05-24T15:01:05.123Z", "level": "WARN", "service_name": "user-service", "message": "Login attempt failed for unknown_user" }
{ "delete" : { "_index" : "products", "_id" : "old_product_id" } }
```

---

## Mapping: Verinizin Kimlik Kartı

Elasticsearch'e veri attığımızda, o verinin nasıl saklanacağını, nasıl analiz edileceğini ve nasıl aranacağını belirleyen kurallar bütününe **mapping** denir.

* Dynamic Mapping: "Sen At, Ben Anlarım" Modu
* Explicit Mapping: "Kurallar Belli Olsun, Sonra Başım Ağrımasın" Modu

--

## Dynamic Mapping

### "Sen At, Ben Anlarım" Modu

* **Avantajları:**
  * Hızlı başlangıç
  * Esneklik
* **Dezavantajları (ve Neden Production'da Pek Sevilmez):**
  * **Yanlış Tip Çıkarımları**
  * **Gereksiz Alanlar ve Analizler**
  * **"Mapping Explosion"**

--

## Explicit Mapping

### "Kurallar Belli Olsun, Sonra Başım Ağrımasın" Modu

```http
PUT /customers
{
  "mappings": {
    "properties": {
      "customer_id": { "type": "keyword" },
      "full_name": {
        "type": "text",
        "analyzer": "standard",
        "fields": {
          "keyword": { "type": "keyword", "ignore_above": 256 }
        }
      },
      "email": { "type": "keyword" },
      "birth_date": { "type": "date", "format": "yyyy-MM-dd" },
      "order_count": { "type": "integer" },
      "last_login_date": { "type": "date" },
      "is_active": { "type": "boolean" },
      "address": {
        "type": "object",
        "properties": {
          "city": { "type": "keyword" },
          "postal_code": { "type": "keyword" }
        }
      }
    }
  }
}
```

---

## En Sık Kullanılan Veri Tipleri ve Amaçları

* `text`: Full-text arama yapılacak metinler için.
* `keyword`: Birebir eşleşme, sıralama (sorting) ve aggregation (gruplama) yapılacak metinler için.
* **Sayısal Tipler:** `long`, `integer`, `short`, `byte`, `double`, `float`, `half_float`, `scaled_float`.
* `date`: Tarih ve zaman bilgileri. Loglar için `@timestamp` alanı olmazsa olmazdır.
* `boolean`: `true` veya `false`.
* `ip`: IPv4 ve IPv6 adresleri için. Loglarda kaynak/hedef IP'ler için kullanılır.
* `geo_point`, `geo_shape`: Coğrafi veriler.
* `object`: İç içe JSON objeleri.
* `nested`: Obje dizileri için.

--

## Önemli Mapping Parametreleri

* **`type`**
* **`analyzer`**
* **`search_analyzer`**
* **`fields`**
* **`dynamic`**
* **`enabled`**
* **`format`**
* **`ignore_above`**

---

# Hadi Biraz Elimizi Kirletelim
