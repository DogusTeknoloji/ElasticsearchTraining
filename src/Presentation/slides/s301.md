# Modül 3: Arama Sanatında Ustalaşın: Query DSL

---

## Arama Sorgusunun Anatomisi: 

### `_search` API'si ile Tanışma

* URI Search (GET ile Basit Aramalar)
* Request Body Search (POST ile Kapsamlı Aramalar)

---

## Query Context vs Filter Context: 

### Skor mu, Hız mı?

* Query Context (`query` anahtarı altında)
* Filter Context (`filter` anahtarı altında, genellikle `bool` sorgusu içinde)

--

## Query Context

* **Amacı:** "Bu doküman, arama kriterlerime **ne kadar iyi** eşleşiyor?" sorusuna cevap arar.
* **Skorlama (`_score`):** Eşleşen her doküman için bir **alaka skoru (`_score`)** hesaplar. Skor ne kadar yüksekse, doküman o kadar alakalı demektir. Sonuçlar varsayılan olarak bu skora göre büyükten küçüğe sıralanır.
* **Kullanım Alanı:** Full-text aramalarda, kullanıcının aradığı şeye en yakın sonuçları bulmak istediğimizde kullanılır. Örneğin, bir ürün adında veya açıklamasında geçen kelimelere göre arama yaparken.
* **Sorgu Tipleri:** Genellikle `match`, `multi_match`, `query_string` gibi full-text sorguları bu context'te kullanılır.

--

## Filter Context

* **Amacı:** "Bu doküman, arama kriterlerime eşleşiyor mu? (Evet/Hayır)" sorusuna cevap arar.
* **Skorlama Yok:** Alaka skoru hesaplanmaz. Bir doküman ya filtreye uyar ya da uymaz.
* **Performans ve Cache'leme:** Skorlama yapılmadığı için genellikle query context'ten daha hızlıdır. Ayrıca, filtre sonuçları Elasticsearch tarafından sıkça **cache'lenebilir**, bu da tekrarlayan sorgularda performansı ciddi şekilde artırır. "Bu filtreyi daha önce görmüştüm, sonucu hazır!" der ES.
* **Kullanım Alanı:** Kesin eşleşmeler, aralıklar veya belirli bir koşulu sağlayan dokümanları bulmak için idealdir. Örneğin, "kategorisi 'Elektronik' olan ürünler", "fiyatı 1000-2000 TL arasında olanlar", "stokta olan ürünler" gibi.
* **Sorgu Tipleri:** Genellikle `term`, `terms`, `range`, `exists` gibi birebir eşleşme veya yapısal sorgular bu context'te kullanılır.

---

## Temel Sorgu Tipleri: 

### Query DSL'e İlk Adımlar

#### Full-Text Sorguları

--

## `match` Sorgusu:

### Standart Full-Text Arama

```http
POST /products/_search
{
    "query": {
        "match": {
            "description": {
                "query": "powerful gaming laptop",
                "operator": "AND"
            }
        }
    }
}
```

--

## `match_phrase` Sorgusu:

### Kelime Grubunu Tam Olarak Arama

```http
POST /products/_search
{
    "query": {
        "match_phrase": {
            "name": "Awesome Laptop"
        }
    }
}
```

--

## `multi_match` Sorgusu:

### Birden Fazla Alanda Arama

```http
POST /products/_search
{
    "query": {
        "multi_match": {
            "query": "silent keyboard",
            "fields": ["name", "description", "tags"]
        }
    }
}
```

--

## `query_string` / `simple_query_string` Sorgusu:

```http
POST /products/_search
{
    "query": {
        "query_string": {
            "query": "(laptop OR gaming) AND category:Computers AND price:>1000",
            "default_field": "description"
        }
    }
}
```

---

## Temel Sorgu Tipleri: 

### Query DSL'e İlk Adımlar

#### Term-Level Sorguları

--

## `term` Sorgusu: 

### Tek Bir Değerle Birebir Eşleşme**

  Verilen değerin alanda tam olarak bulunup bulunmadığını kontrol eder.

```http
POST /products/_search
{
    "query": {
        "term": {
            "category": "Accessories" // category alanı keyword olmalı
        }
    }
}
```

--

## `terms` Sorgusu:

### Birden Fazla Değerle Eşleşme (`IN` gibi)

Alanda belirtilen değerlerden herhangi birinin bulunup bulunmadığını kontrol eder.

```http
POST /products/_search
{
    "query": {
        "terms": {
            "tags": ["laptop", "gaming", "new-gen"] // tags alanı keyword olmalı
        }
    }
}
```

--

## `ids` Sorgusu:

### Belirli ID'lere Sahip Dokümanları Getirme

```http
POST /products/_search
{
    "query": {
        "ids": {
            "values": ["SKU001", "SKU003"]
        }
    }
}
```

--

## `range` Sorgusu:

### Belirli Bir Aralıktaki Değerler

Sayısal, tarih veya string alanlarında belirli bir aralıktaki değerleri bulur.

```http
POST /products/_search
{
    "query": {
        "range": {
            "price": {
                "gte": 70,     // greater than or equal to (büyük veya eşit)
                "lt": 500      // less than (küçük)
            }
        }
    }
}
```

--

## `exists` Sorgusu: 

### Alanın Var Olup Olmadığı

Belirli bir alanın dokümanda var olup olmadığını (null veya boş dizi olmaması) kontrol eder.

```http
POST /products/_search
{
    "query": {
        "exists": {
            "field": "description"
        }
    }
}
```

--

## `prefix` Sorgusu: 

### Belirli Bir Önekle Başlayanlar**

`keyword` alanlarında belirli bir önekle başlayan değerleri bulur.

```http
POST /products/_search
{
    "query": {
        "prefix": {
            "sku": "SKU"
        }
    }
}
```

--

## `wildcard` Sorgusu:

### Joker Karakterlerle Desen Eşleştirme

`*` (birden fazla karakter) ve `?` (tek karakter) jokerlerini kullanarak desen eşleştirmesi yapar.

```http
POST /products/_search
{
    "query": {
        "wildcard": {
            "name.keyword": { // Genellikle .keyword alanında kullanılır
                "value": "Lap*Pro"
            }
        }
    }
}
```

---

## Temel Sorgu Tipleri: 

### Query DSL'e İlk Adımlar

#### Diğer Kullanışlı Sorgular

--

## `match_all` Sorgusu:

### Tüm Dokümanları Getir

Herhangi bir filtreleme yapmadan index'teki tüm dokümanları getirir.

```http
POST /products/_search
{
    "query": {
        "match_all": {}
    }
}
```

--

## `match_none` Sorgusu: 

### Hiçbir Dokümanı Getirme

Hiçbir dokümanı getirmez. Nadiren kullanılır.

---

## Sorguları Birleştirme Sanatı: 

### `bool` Sorgusu

`bool` sorgusu, diğer sorgu tiplerini mantıksal operatörlerle (`AND`, `OR`, `NOT`) birleştirmemizi sağlar.

Dört ana bölümü vardır:

* **`must`:** (lojik `AND`)
* **`filter`:** (lojik `AND`)
* **`should`:** (lojik `OR`)
  * `minimum_should_match`
* **`must_not`:** (lojik `NOT`)

--

## `bool` Sorgusu

```http
POST /products/_search
{
  "query": {
    "bool": {
      "must": [
        {
          "multi_match": {
            "query": "gaming keyboard",
            "fields": ["name", "description"]
          }
        }
      ],
      "filter": [
        { "term": { "category": "Accessories" } },
        { "range": { "price": { "lt": 100 } } }
      ],
      "must_not": [
        { "term": { "tags": "refurbished" } }
      ],
      "should": [
        { "term": { "tags": "new-arrival" } }
      ]
    }
  }
}
```

---

## HADİ ELİMİZİ KİRLETELİM
