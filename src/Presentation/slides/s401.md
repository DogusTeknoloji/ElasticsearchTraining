# Modül 4: Analizin Gücü: Aggregation'larla Veriye Hükmetmek

---

## Aggregation'lara Giriş:

### Nedir, Ne İşe Yarar?

Aggregation'lar, arama sonuçlarınızdaki dokümanları gruplara ayırmanıza (bucket'lama) ve bu gruplar üzerinde çeşitli metrikler (hesaplamalar) yapmanıza olanak tanır. Örneğin:

* Her kategoride kaç ürün var?
* En popüler etiketler hangileri?
* Belirli bir fiyat aralığındaki ürünlerin ortalama stok miktarı nedir?
* Aylık satış trendleri nasıl?
* Hangi servis en çok hata logu üretiyor?
* Günün hangi saatlerinde hata yoğunluğu artıyor?

--

### Örnek

```http
POST /products/_search
{
    "query": {
        "match_all": {}
    },
    "aggs": {
        "my_first_aggregation": {
            // Aggregation tanımı buraya gelecek
        }
    },
    "size": 0
}
```

---

## Bucket Aggregations: 

### Veriyi Anlamlı Gruplara Ayırmak

--

## `terms` Aggregation: 

### Benzersiz Değerlere Göre Gruplama

Belirli bir alandaki benzersiz değerlere göre dokümanları gruplar. SQL'deki `GROUP BY some_field` gibi.

```http
POST /products/_search
{
    "aggs": {
        "products_by_category": {
            "terms": { "field": "category" }
        }
    },
    "size": 0
}
```

--

## `range` / `date_range` Aggregation: 

### Belirli Aralıklara Göre Gruplama**

Sayısal veya tarih alanlarında sizin tanımladığınız aralıklara göre gruplama yapar.

```http
POST /products/_search
{
    "aggs": {
        "products_by_price_range": {
        "range": {
            "field": "price",
            "ranges": [
                { "to": 100.0 },
                { "from": 100.0, "to": 500.0 },
                { "from": 500.0 }
            ]
        }
        }
    },
    "size": 0
}
```

--

## `histogram` / `date_histogram` Aggregation: 

### Sabit Aralıklara Göre Gruplama

Sayısal veya tarih alanlarında sabit bir aralığa (`interval`) göre bucket'lar oluşturur.

```http
POST /products/_search
{
    "aggs": {
        "products_by_price_histogram": {
            "histogram": {
              "field": "price",
              "interval": 500,
              "min_doc_count": 1
            }
        }
    },
    "size": 0
}
```

--

## `filter` / `filters` Aggregation: 

### Filtreye Uyanları Gruplama

`filter` tek bir filtreye uyan dokümanları tek bir bucket'a koyar. `filters` ise birden fazla isimlendirilmiş filtre tanımlamanızı ve her birine uyanları ayrı bucket'lara koymanızı sağlar.

```http
POST /products/_search
{
    "aggs": {
        "stock_status_split": {
            "filters": {
                "filters": {
                    "in_stock_products": { "term": { "is_active": true } },
                    "out_of_stock_products": { "term": { "is_active": false } }
                }
            }
        }
    },
    "size": 0
}
```

---

## Metric Aggregations: 

### Gruplar Üzerinde Hesaplamalar Yapmak

--

## `min`, `max`, `avg`, `sum` Aggregations: 

### Temel İstatistikler

Belirli bir sayısal alanın minimum, maksimum, ortalama veya toplam değerini hesaplar.

```http
POST /products/_search
{
    "aggs": {
        "average_price": {
            "avg": { "field": "price" }
        },
        "total_stock": {
            "sum": { "field": "stock_quantity"}
        }
    },
    "size": 0
}
```

--

## `stats` / `extended_stats` Aggregations: 

### Kapsamlı İstatistikler

`stats`, tek seferde `count`, `min`, `max`, `avg`, `sum` değerlerini verir. `extended_stats` ise bunlara ek olarak `sum_of_squares`, `variance`, `std_deviation` (standart sapma) gibi daha ileri istatistikleri de sunar.

```http
POST /products/_search
{
    "aggs": {
        "price_stats": {
            "stats": { "field": "price" }
        }
    },
    "size": 0
}
```

--

## `cardinality` Aggregation: 

### Benzersiz Değer Sayısı (Yaklaşık)

Belirli bir alandaki benzersiz değer sayısını tahmin eder. SQL'deki `COUNT(DISTINCT field)` gibi. Büyük veri setlerinde tam sayım pahalı olabileceği için HyperLogLog++ algoritmasını kullanarak yaklaşık ama hızlı bir sonuç verir.

```http
POST /products/_search
{
    "aggs": {
        "distinct_categories": {
            "cardinality": { "field": "category" }
        }
    },
    "size": 0
}
```

--

## `percentiles` / `percentile_ranks` Aggregations: 

### Yüzdelik Dilimler

`percentiles`, verinin belirli yüzdelik dilimlerini (örneğin, %50 (medyan), %95, %99) gösterir. `percentile_ranks` ise belirli değerlerin hangi yüzdelik dilime denk geldiğini gösterir. Performans izleme (örneğin, isteklerin %99'u kaç ms altında tamamlanıyor?) için çok kullanışlıdır.

---

## İç İçe Aggregation'lar: 

### Detayın Detayına İnmek

--

## Örnek

```http
POST /products/_search
{
  "aggs": {
    "categories": {
      "terms": { "field": "category" },
      "aggs": {
        "average_price_per_category": {
          "avg": { "field": "price" }
        }
      }
    }
  },
  "size": 0
}
```

---

## HADİ ELİMİZİ KİRLETELİM
